# SMOKE-MOVES

SMOKE-MOVES is a set of methodologies and software tools to help use output from MOVES3 or MOVES4 as inputs to SMOKE. [Section 3.2](https://www.cmascenter.org/smoke/documentation/4.9/html/ch03s02.html) of the SMOKE User's Manual describes the various scripts and files that make up SMOKE-MOVES.

The current version of SMOKE-MOVES creates run specification files designed for use in MOVES4 (through MOVES4.0.1).

To use SMOKE-MOVES with MOVES3 (through MOVES3.0.3), make sure to download the version tagged as "[MOVES3](https://github.com/CEMPD/SMOKE-MOVES/archive/refs/tags/MOVES3.zip)".

<!-- If you would like to download a package of SMOKE-MOVES scripts and inputs used in EPA's modeling platform, please visit the EPA's [Emissions Modeling Platforms](https://www.epa.gov/air-emissions-modeling/emissions-modeling-platforms) page.

For information on installing MOVES2014a on Linux, read the [wiki page](https://github.com/CEMPD/SMOKE-MOVES/wiki/Installing-MOVES2014a-on-Linux). -->

## SMOKE-MOVES Processing Scripts

SMOKE-MOVES can be downloaded as a zip archive, for the version of MOVES you are using:

- [MOVES3](https://github.com/CEMPD/SMOKE-MOVES/archive/refs/tags/MOVES3.zip)
- [MOVES4](https://github.com/CEMPD/SMOKE-MOVES/archive/master.zip)

This package assumes a base directory of `/opt/SMOKE-MOVES/`. Update the following input files with your installation location:

```
inputs/countyrep.in
inputs/06001/control.in
```

Also, set the location of your MOVES installation in `inputs/06001/control.in`:

`MOVESHOME      = /opt/MOVES4`

Generate import scripts and runspec files:

`> scripts/runspec_generator.pl inputs/06001/control.in inputs/countyrep.in -csh`

Import custom county data:

`> csh runspec_files/06001/06001_2011importer.csh`

Run MOVES:

`> csh runspec_files/06001/06001_2011runspec.csh`

After MOVES finishes running, generate the emission factor files.

```
> mkdir efs
> mkdir efs/06001
```

Rate-per-distance factors:

```
> scripts/moves2smkEF.pl -r RPD \
    --formulas scripts/pollutant_formulas_AQ.txt \
    --proc_agg scripts/process_aggregation.csv \
    runspec_files/06001/06001_2011outputDBs.txt \
    scripts/pollutant_mapping_AQ_CB05.csv efs/06001/
```

Rate-per-vehicle factors:

```
> scripts/moves2smkEF.pl -r RPV \
    --formulas scripts/pollutant_formulas_AQ.txt \
    --proc_agg scripts/process_aggregation_rpv_no_rps.csv \
    runspec_files/06001/06001_2011outputDBs.txt \
    scripts/pollutant_mapping_AQ_CB05.csv efs/06001/
```

Rate-per-profile factors:

```
> scripts/moves2smkEF.pl -r RPP \
    --formulas scripts/pollutant_formulas_AQ.txt \
    --proc_agg scripts/process_aggregation.csv \
    runspec_files/06001/06001_2011outputDBs.txt \
    scripts/pollutant_mapping_AQ_CB05.csv efs/06001/
```

Rate-per-hour factors:

```
> scripts/moves2smkEF.pl -r RPH \
    --formulas scripts/pollutant_formulas_AQ.txt \
    --proc_agg scripts/process_aggregation.csv \
    runspec_files/06001/06001_2011outputDBs.txt \
    scripts/pollutant_mapping_AQ_CB05.csv efs/06001/
```

Rate-per-start factors:

```
> scripts/moves2smkEF.pl -r RPS \
    --formulas scripts/pollutant_formulas_AQ.txt \
    --proc_agg scripts/process_aggregation.csv \
    runspec_files/06001/06001_2011outputDBs.txt \
    scripts/pollutant_mapping_AQ_CB05.csv efs/06001/
```

Off-network idling factors:

```
> scripts/moves2smkEF.pl -r RPHO \
    --formulas scripts/pollutant_formulas_AQ.txt \
    --proc_agg scripts/process_aggregation_rpho.csv \
    runspec_files/06001/06001_2011outputDBs.txt \
    scripts/pollutant_mapping_AQ_CB05.csv efs/06001/
```

## Humidity adjustments

By default, MOVES3 and MOVES4 will adjust the calculated NOx emission factors to adjust for humidity. When using SMOKE-MOVES, this adjustment can instead be handled by the SMOKE program **Movesmrg** which can apply more detailed adjustments based on hourly, gridded meteorology data.

In order to turn off the humidity adjustment in MOVES, two different procedures are used for MOVES3 vs. MOVES4.

### Turn off humidity adjustments in MOVES3

Download the database nonoxadj_moves3 from https://gaftp.epa.gov/Air/emismod/MOVES3/other_inputs/nonoxadj_moves3.zip and load it into your MySQL or MariaDB server. The runspec files generated by the runspec generator script automatically include this database in the MOVES configuration.

### Turn off humidity adjustments in MOVES4

In the default MOVES4 database (named movesdb20230615 [MOVES4.0.0] or movesdb20240104 [MOVES4.0.1]), the table named noxHumidityAdjust needs to be emptied:

```
CREATE TABLE noxHumidityAdjust_full LIKE noxHumidityAdjust; 
INSERT INTO noxHumidityAdjust_full SELECT * FROM noxHumidityAdjust;
TRUNCATE noxHumidityAdjust;
``` 

The SQL commands above create a backup of the noxHumidityAdjust table before removing the entries in the table. To re-enable the NOx humidity adjustments in MOVES4, rename noxHumidityAdjust_full back to noxHumidityAdjust before running MOVES.

### Configure moves2smkEF.pl for humidity adjustments

The SMOKE-MOVES post-processing script moves2smkEF.pl needs to be informed about whether or not the MOVES emission factors have had humidity adjustments applied. When running moves2smkEF.pl for the various modes (RPD, RPV, etc.), include the command line flag `--moves_adjusted_nox N` to indicate that humidity adjustments were **NOT** applied by MOVES.

If moves2smkEF.pl is run with the flag `--moves_adjusted_nox N`, the output emission factor tables will include the header line

```
HUMIDITY_ADJUSTED_NOX N
```

When running the SMOKE program **Movesmrg**, the option `APPLY_NOX_HUMIDITY_ADJ` can be used to apply humidity corrections.

## Data sources

### County-specific MOVES data

Previously, SMOKE-MOVES loaded county-specific data into MOVES via CSV files. Now, the input file `inputs/countyrep.in` specifies the database to use for each representative county. For example:

```
<REPCOUNTY>
FIPS=06001
CDB=c06001y2011_20150522
<ENDREPCOUNTY>
```

Default county input databases are available for download from the EPA. Note that the database schema for the county inputs changed with the release of MOVES3.

For MOVES3:
- 2016: https://gaftp.epa.gov/Air/emismod/2016/v3/2016emissions/2016v3_CDBs_MOVES3_v2WithST62AgeDistUpdate_20220606.zip
- 2017: https://gaftp.epa.gov/Air/MOVES3/2017/2017repCDBs_20201209.zip

For MOVES4:
- 2021: https://gaftp.epa.gov/Air/emismod/2021/2021emissions/CDBs_2021_20240205.zip

### Meteorology files

```
inputs/MOVES_DAILY_12US2_2011001-2011365.txt
inputs/MOVES_RH_DAILY_12US2_2011001-2011365.txt
```

National versions of these [Met4moves](https://www.cmascenter.org/smoke/documentation/4.8.1/html/ch06s07.html) output files are available from the EPA at https://gaftp.epa.gov/Air/emismod/2016/v1/ancillary_data/ge_dat_for_2016v1_other_31oct2019.zip

Example Met4moves scripts are available from the EPA at https://gaftp.epa.gov/Air/emismod/2017/met4moves_example_scripts_2017.zip
